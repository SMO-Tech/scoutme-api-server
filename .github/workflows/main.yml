name: Deploy to EC2

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH (git pull on server)
        uses: appleboy/ssh-action@v1.2.2
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          GH_REPO: ${{ github.repository }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_SSH_PORT || 22 }}
          envs: GH_TOKEN,GH_REPO
          script: |
            # 1. Setup Directory
            mkdir -p ~/scoutme-api-server
            cd ~/scoutme-api-server
            
            # 2. Git Pull / Clone
            REPO_URL="https://x-access-token:${GH_TOKEN}@github.com/${GH_REPO}.git"
            if [ -d .git ]; then
              # Already a git repo, update remote URL and pull
              git remote set-url origin "$REPO_URL"
              git fetch origin main
              git reset --hard origin/main
            else
              # First time setup - clone the repo
              git clone "$REPO_URL" .
            fi
            
            # 3. Install Dependencies
            npm install
            npx prisma generate
            
            # 4. CLEANUP: Delete old build
            echo "üßπ Deleting old dist folder..."
            rm -rf dist
            
            # 5. Build Fresh
            echo "üèóÔ∏è  Building project..."
            npm run build
            
            # 6. STOP & KILL: The "Nuclear" Option for Port 4000
            echo "üíÄ Killing any process blocking Port 4000..."
            
            # Stop PM2 backend first (ignore error if it's already stopped)
            pm2 stop backend || true
            
            # Find whatever is holding port 4000 and force kill it (-9)
            # This handles the "zombie" process issue you faced earlier
            sudo lsof -t -i:4000 | xargs -r sudo kill -9
            
            # 7. Start Application
            echo "üöÄ Starting Backend..."
            pm2 start dist/index.js --name backend
            
            # Save the list so it survives reboots
            pm2 save
